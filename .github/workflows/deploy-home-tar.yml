name: Deploy AI Risk via Docker Compose (Home Server)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Ensure Git LFS objects are present
        run: |
          git lfs install --local
          # Pull only the big dataset we need (faster)
          git lfs pull --include="backend/data/raw/gtd.csv" || true
          # sanity check
          if [ -f backend/data/raw/gtd.csv ]; then
            echo "gtd.csv present, size: $(wc -c < backend/data/raw/gtd.csv) bytes"
          else
            echo "WARNING: gtd.csv not found after git lfs pull"
          fi

      - name: Add SSH host key
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          ssh-keyscan -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Load SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Build Docker images (on runner)
        run: |
          docker build -t ai-risk-api:latest -f backend/Dockerfile ./backend
          docker build -t ai-risk-web:latest -f frontend/Dockerfile ./frontend

      - name: Save & upload Docker TARs
        run: |
          docker save ai-risk-api:latest > ai-risk-api.tar
          docker save ai-risk-web:latest > ai-risk-web.tar
          scp -P ${{ secrets.VPS_PORT }} ai-risk-api.tar ai-risk-web.tar dmitri@${{ secrets.VPS_HOST }}:/tmp/

      - name: Upload project files to server (exclude backend/data)
        run: |
          rsync -avz -e "ssh -p ${{ secrets.VPS_PORT }}" \
            --exclude 'backend/data/' \
            --exclude 'ai-risk-api.tar' --exclude 'ai-risk-web.tar' \
            ./ dmitri@${{ secrets.VPS_HOST }}:/home/dmitri/ai-risk

      - name: (optional) Upload gtd.csv separately if you want to overwrite server copy
        if: ${{ always() }}
        run: |
          # Если вы хотите, чтобы CI автоматически перезаписал gtd.csv на сервере,
          # раскомментируйте следующие строки и закомментируйте шаг rsync выше.
          # scp -P ${{ secrets.VPS_PORT }} backend/data/raw/gtd.csv dmitri@${{ secrets.VPS_HOST }}:/home/dmitri/ai-risk/backend/data/raw/gtd.csv
          echo "To auto-copy gtd.csv uncomment the scp line in this step."

      - name: Load and restart containers on server
        run: |
          ssh -p ${{ secrets.VPS_PORT }} dmitri@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            cd ~/ai-risk
            # load the images (they contain real data because we ran git lfs pull before build)
            docker load < /tmp/ai-risk-api.tar
            docker load < /tmp/ai-risk-web.tar
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            rm -f /tmp/ai-risk-api.tar /tmp/ai-risk-web.tar
          EOF
